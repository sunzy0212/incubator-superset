{% extends "superset/basic.html" %}

{% block title %}{{ _("Welcome!") }}{% endblock %}

{% block body %}
<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="/static/assets/dist/libs/progressbar.js"></script>
<div id="confirmLoadData" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">确认</h4>
      </div>
      <div class="modal-body">
        <p>是否需要导入样例数据？</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">不需要</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">导入数据</button>
      </div>
    </div>
  </div>
</div>

<div id="waitForLoadingData" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="loading-title" class="modal-title">正在导入数据</h4>
      </div>
      <div class="modal-body">
        <p class="dialog-message">已等待 0 秒</p>
        <div id="progressbar" style="width: 100%; height: 5px"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal" disabled>完成</button>
      </div>
    </div>
  </div>
</div>

<script>
    var csrftoken = $("input[name='csrf_token']").attr("value");
    $.ajaxSetup( {
        beforeSend: function ( xhr ) {
            xhr.setRequestHeader( 'X-CSRF-Token', csrftoken );
        }
    });
    $(document).ready(function() {
        if (!localStorage["didLoginBefore"]) {
            localStorage["didLoginBefore"] = true;
            $("#confirmLoadData button.btn-primary").on("click", function() {
                $("#waitForLoadingData").modal("show");
                var container = $("#progressbar");
                var bar = new ProgressBar.Line(container[0], {
                    strokeWidth: 4,
                    easing: 'easeInOut',
                    duration: 1400,
                    color: '#258CF7',
                    trailColor: '#eee',
                    trailWidth: 1,
                    svgStyle: {width: '100%', height: '100%'}
                });

                var count = 0;
                var timer;
                function updateMessage() {
                    $("#waitForLoadingData p.dialog-message").text("已等待 " + count + " 秒");
                    timer = setTimeout(updateMessage, 1000);
                    count++;
                    if (count > 9) {
                        const c = count - 9;
                        bar.animate(0.9 + (1 - 1 / c) * 0.1);
                    } else {
                        bar.animate(count / 10);
                    }
                }
                updateMessage();

                function handleResult(success, errMessage) {
                    if (timer !== undefined) {
                        clearTimeout(timer);
                    }
                    container.attr("style", "display: none");
                    var text = success ? "数据已全部更新" : ("更新数据失败：" + errMessage);
                    $("#loading-title").text("完成");
                    $("#waitForLoadingData p.dialog-message").text(text);
                    $("#waitForLoadingData button").removeAttr("disabled");
                }

                $.ajax({
                    url: "/biserverbackendview/load_examples",
                    method: "POST",
                    headers: {'X-CSRF-Token': csrftoken},
                    success: function() {
                        handleResult(true);
                    },
                    error: function(err) {
                        var status = err.status,
                            responseText = err.responseText;
                        if (responseText) {
                            try {
                                const jsonObject = JSON.parse(responseText);
                                if (jsonObject && jsonObject.error) {
                                    responseText = jsonObject.error;
                                }
                            } catch (err) {}
                        }
                        if (status === 409 && responseText.match(/^E8009/)) {
                            // 409: E8009 means database exist. it's successful.
                            handleResult(true);
                        } else {
                            handleResult(false, responseText);
                        }
                    },
                });
            });
            $("#confirmLoadData").modal("show");
        }
    });
</script>
<div class="container welcome" style="margin-left: auto; margin-right: auto">
  {% include 'superset/flash_wrapper.html' %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">
        <div class="row">
          <div class="col-md-6">
            <h2>{{ _("Dashboards") }}</h2>
          </div>
          <div class="col-md-6">
            <div class="search-container pull-right">
              <i class="fa fa-search"></i>
              <span class="search"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="panel-body">
      <img class="loading" src="/static/assets/images/loading.gif"/>
      <table id="dash_table" class="table" width="100%"></table>
    </div>
  </div>
</div>
{% endblock %}

